This demo presents a serverless ML pipeline for clustering large-scale datasets using AWS Athena and AWS Lambda.

**Pipeline Stages:**
1. **Distance Calculation & Filtering (Athena):**  
   SQL queries in Athena compute and filter pairwise distances, efficiently processing billions of records and reducing data transfer.

2. **Clustering (AWS Lambda):**  
   The clustering algorithm (scikit-learn) runs in Lambda, leveraging pre-filtered data for fast, scalable execution within Lambdaâ€™s limits.

**Key Benefits:**
- **Serverless & Scalable:** No infrastructure management required.
- **Cost-Effective:** Pay-per-query with Athena.
- **Performance:** Minimizes data movement by keeping computations in the data lake.
- **Reusable:** Adaptable for other ML workflows.

## Running the demo

To run the demo, follow these steps:
1. **Set Up AWS Environment:**
   - Ensure you have an AWS account with permissions to create Lambda functions and Athena queries.
   - Create an S3 bucket for input and output data.
2. **Deploy the Lambda Function:**
   - Use the provided Lambda function code to create a new Lambda function in your AWS account.
   - Configure the Lambda function with the necessary environment variables (bucket name, input/output folders, etc.).
3. **Prepare Input Data:**
    - Create the sample data file by running the `create_sample_data.py` script. This will generate a csv.gz file with raw data.
    - Create an Athena table pointing to the S3 bucket where the input data is stored. Use the provided SQL script to create the table.
```sql
CREATE DATABASE demo;

CREATE EXTERNAL TABLE IF NOT EXISTS demo.customers (
  customer_id INT,
  gender STRING,
  age INT,
  city STRING,
  product_ids ARRAY<SMALLINT>
)
ROW FORMAT SERDE 'org.openx.data.jsonserde.JsonSerDe'
LOCATION 's3://lambda-clustering-demo/customers/'; 
```
   - Verify that the data is correctly loaded into Athena by running a simple query:
```sql
SELECT * FROM demo.customers LIMIT 10;
 ```
4. **Run the Athena Query:**
   - Execute the provided Athena query to calculate pairwise distances and filter the results.
   - The query will output the results to the specified S3 bucket.
```sql
-- Use athena CTAS to create a new json.gz file with daily distances data
CREATE TABLE demo.customer_distances
WITH (
  external_location = 's3://lambda-clustering-demo/distances/day=2025-06-10/',
  format = 'TEXTFILE',
  field_delimiter = ',',
  bucket_count=1,
  bucketed_by = ARRAY['customer_id1']
) AS
SELECT c1.customer_id AS customer_id1, c2.customer_id AS customer_id2, distance
-- join the table with itself to go over all pairs of customers
FROM demo.customers AS c1 INNER JOIN demo.customers AS c2 ON c1.customer_id < c2.customer_id
     CROSS JOIN LATERAL (SELECT
       -- Each feature has a weight, and the distance is calculated based on the conditions
       0.5 * (1 - 0.2 * LEAST(REDUCE(c1.product_ids, 0, (s, x) -> IF(CONTAINS(c2.product_ids, x), s + 1, s), s -> s), 5)) +
       0.25 * IF(ABS(c1.age - c2.age) > 5 AND c1.gender = c2.gender, 1, 0) +
       0.25 * IF(c1.city = c2.city, 0, 1)
     AS distance)
-- fileter distances for efficient clustering
WHERE distance <= 0.5
-- limit the number of rows to control the size of the output
LIMIT 1000000;
```
4. **Review the Output:**
   - Check the S3 bucket for the output files generated by the Athena query.
   - Verify that the Lambda function executed successfully and the clustering results are stored in the output folder.
   - Download the output files and inspect the clustering results. You can also create an external table in Athena to query the results directly.

5. **Cleanup:**
   - After testing, delete the Lambda function and S3 bucket, and Athena tables to avoid unnecessary charges.
```sql
DROP TABLE IF EXISTS demo.customer_distances;
DROP TABLE IF EXISTS demo.customers;
DROP DATABASE IF EXISTS demo;
```